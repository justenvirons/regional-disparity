---
title: "Evaluation of Chronic Health Disparities: An analysis within CCDPH"
author: "C. Scott Smith, PhD AICP"
date: "June 2, 2021"
output: html_document
---

```{r chunk-options, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	include=TRUE
)
```

```{r r-packages-settings, include=FALSE}

library(dplyr)
library(tidyverse)
library(sf)
library(sp)
library(spdep)
library(leaflet)
library(leaflet.providers)
library(kableExtra)

# Change the presentation of decimal numbers to 4 and avoid scientific notation
options(prompt="R> ", digits=4, scipen=999)
```

``` {r import-subset-census-data, include=FALSE}

# import TIGER/Line cartographic boundary shapefiles
INIL_Tracts_geom <- st_read("../layers/INIL_Tracts_geom.shp")
INIL_Places_geom <- st_read("../layers/INIL_Places_geom.shp")
INIL_Counties_geom <- st_read("../layers/INIL_Counties_geom.shp")

# subset counties, rename variables
studyarea_counties <- INIL_Counties_geom %>% 
  filter(STATEFP=="17" | STATEFP=="18",
         GEOID=="17031" | GEOID=="17043" | GEOID=="17089" | GEOID=="17093" | GEOID=="17097" | GEOID=="17111" | GEOID=="17197" | GEOID=="18089") %>%
  rename(geoid_county = GEOID,
         state_county = STATEFP,
         name_county = NAME) %>%
  mutate(sqmi_land_county = ALAND*0.00000038610,
         sqmi_water_county = AWATER*0.00000038610,
         sqmi_county = sqmi_land_county+sqmi_water_county) %>%
  select(-c(COUNTYFP:AFFGEOID, LSAD:AWATER))

# create region analysis boundary
studyarea_region <- studyarea_counties %>% 
  st_union() %>% 
  st_as_sf() %>% 
  mutate(studyarea="region")

# subset places using region analysis boundary
studyarea_places <- INIL_Places_geom %>% 
  mutate(area_tot = st_area(geometry)) %>%
  st_intersection(studyarea_region) %>%
  mutate(area_int = st_area(geometry),
         area_int_pct = as.numeric(area_int/area_tot*100)) %>%
  filter(area_int_pct >= 1)

# subset study area tracts data using study area county fips
studyarea_tracts <- INIL_Tracts_geom %>% 
  mutate(geoid_county = paste0(STATEFP,COUNTYFP)) %>%
  rename(geoid_tract = GEOID,
         sqmi_land_tract = sqmi_land,
         sqmi_water_tract = sqmi_water) %>%
  st_join(studyarea_counties, by="geoid_county") %>%
  drop_na(name_county) %>%
  distinct(geoid_tract,.keep_all = TRUE)

# remove raw data
rm(INIL_Places_geom, INIL_Counties_geom, INIL_Tracts_geom) 
```

```{r import-subset-places-data, include=FALSE}

# import PLACES chronic disease data
places_tracts <- read_csv("../data/places_tracts.csv")
places_datadictionary <- read_csv("../data/places_datadictionary.csv") %>% select(Name,Description)

# join study area census tracts with places data
studyarea_tracts_disease <- places_tracts %>% 
  rename(geoid_tract=TractFIPS) %>%
  right_join(studyarea_tracts, by="geoid_tract") %>%
  select(geoid_tract,
         ends_with("CrudePrev"),
         sqmi_land_tract,
         sqmi_water_tract,
         sqmi,
         -c(TotalPopulation,StateAbbr:CountyFIPS))

rm(places_tracts)
```

# Background
This report maps the geographic patterning of chronic health conditions within CCDPHâ€™s jurisdiction to identify disease hot spots and evaluate differences in outcomes by sociodemographic group. The report finds that: (1) the spatial arrangement and magnitude of geographic clusters vary by disease; and (2) considerable racial, ethnic and economic disparities of health outcomes exist between sociodemographic groups. These findings can be used to inform Department policy and allocate public health resources in ways that promote public health equity.

# Study areas
We carry out analyses of chronic disease prevalence at two geographic scales. First, we examine broader public health patterns across eight counties in the Chicago metro region: Cook, DuPage, Kane, Kendall, Lake (IL), McHenry and Will in Illinois and Lake (IN) in northwestern Indiana. Collectively, these counties span an area of 4,573 square miles (11,845 square kilometers) and have a combined residential population of 8.9 million (2019).

The regional analysis is followed by a more granular assessment of disease and disparity within CCDPH's jurisdiction, with special attention paid to 32 priority communities that have experienced disproportionate hardships due to COVID-19. CCDPH's jurisdiction--a subset of the broader region--spans a square mile area surrounding, composed of 125 municipalities and other incorporated areas bordering the north, west and south sides of the city of Chicago. According to the latest census, the jurisdiction spans square miles and has a residential population (2019).

``` {r import-subset-acs-data}

# import race/ethnic data
acs2019_bytract <- read_csv("../data/acs2019_bytract.csv") %>%
  mutate(GEOID = as.character(GEOID))

studyarea_counties_acs <- acs2019_bytract %>% 
  mutate(geoid_county = substr(GEOID,1,5)) %>% 
  right_join(studyarea_counties, by="geoid_county") %>%
  group_by(geoid_county) %>%
  summarize_at(.vars = vars(TotalPop:PopWht, TotalPov:PopBPov), .funs=c(sum="sum")) %>%
  left_join(studyarea_counties, by="geoid_county") %>%
  st_as_sf()

labels <- sprintf(
  "<strong>%s</strong><br/>%g mi<sup>2</sup>",
  studyarea_counties_acs$name_county, studyarea_counties_acs$sqmi_county) %>% lapply(htmltools::HTML)

leaflet() %>% 
  addPolygons(data=studyarea_counties_acs %>% st_transform(crs=4326),
              fillColor = "orange",
              weight = 2,
              opacity = 0.5,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(
              weight = 5,
              color = "#666",
              dashArray = "",
              fillOpacity = 0.7,
              bringToFront = TRUE),
              label = labels,
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px",
                direction = "auto")) %>%
  addProviderTiles(providers$CartoDB.Positron)
```

# Data & methodology

Three datasets were used to inform the analyses: 

## CDC's PLACES modeled chronic disease prevalence data (link)
The small-area PLACES dataset, published by the Center for Disease Control (CDC) in 2020, was used to identify neighborhood-level disease clusters at the census tract level throughout the two study areas. Modeled estimates in the dataset were generated using a multilevel regression and poststratfication (MRP) approach that links geocoded health survey data from CDC's Behavioral Risk Factor Surveillance System (BRFSS) with fine-grain demographic and socioeconomic data from the 2010 decennial census and American Community Survey (ACS). The dataset includes 28 measures including five unhealthy behaviors, 15 health outcomes, and nine prevention practices. See appendix in this report for measure-specific descriptions.  

## American Community Survey (ACS) population and socioeconomic data (link)
ACS 5-year estimates made available via the US Bureau of the Census were used to compare prevalence rate ratios across communities by sociodemographic group. Specifically, we use race, ethnicity and economic (i.e., poverty) status information.

## TIGER/Line geographic data
Shapefiles for the data...made available. Cartographic boundaries...transformed into 26916, UTM Zone 16 to allow for more accurate spatial statistical modeling.

# Analytical approach
The analysis followed three steps. In step one, we map regional patterns of disease prevalence for each of the 28 health measures and calculate Moran's I values to estimate global measures of spatial. Next, we categorize the prevalence rates into quintile groups, The three sets of data were used to used to create global and local measures of spatial autocorrelation to identify a series of chronic disease clusters throughout the metropolitan area. These statistics are then evaluated to better understand both the relative intensity and spatial patterning of clustering across diseases and communities.

```{r spatial-autocorrelation}

# create neighborhood structure 
tracts_nb <- poly2nb(studyarea_tracts, queen=TRUE)
# tracts_nb

# define weights matrix
tracts_wm <- nb2listw(tracts_nb)
# tracts_wm

health_types <- as.data.frame(colnames(studyarea_tracts)) %>%
  rename(type = 1) %>%
  filter(str_detect(type,"CrudePrev"))

moran_stats <- data.frame(matrix(NA, ncol = 6, nrow = 0)) %>%
  rename(type = 1,
         morani = 2,
         morane = 3,
         moranv = 4,
         moransd = 5,
         moranp = 6) %>%
  mutate(type = as.character(type),
         morani = as.numeric(morani),
         morane = as.numeric(morane),
         moranv = as.numeric(moranv),
         moransd  = as.numeric(moransd),
         moranp = as.numeric(moranp)
         )

for (i in 1:nrow(health_types)) {
  
  studyarea_tracts_type <- studyarea_tracts %>%
    st_drop_geometry() %>% 
    select(health_types$type[i])
  
tracts_moran <- moran.test(studyarea_tracts_type[[1]], tracts_wm, na.action = na.omit)

moran_stats <- moran_stats %>%
  bind_rows(as.data.frame(list(
health_types$type[i],
tracts_moran$estimate[[1]],
tracts_moran$estimate[[2]],
tracts_moran$estimate[[3]],
tracts_moran$statistic[[1]],
tracts_moran$p.value)) %>%
  rename(type = 1,
         morani = 2,
         morane = 3,
         moranv = 4,
         moransd = 5,
         moranp = 6))
}

moran_stats %>% 
  arrange(-morani) %>% 
  select(Name = type,
         "Moran's I" = morani,
         "Standard Deviation" = moransd,
         -morane, 
         -moranv) %>%
    filter(str_detect(Name,"CrudePrev")) %>%
  mutate(Name = tolower(str_replace_all(Name, "_CrudePrev", ""))) %>%
  kbl(caption=paste0("Moran's I Statistics for Chicago Metropolitan Area by Chronic Health Prevalance Category")) %>%
  kable_classic(full_width=F)

```

```{r prevalence-index}

# create function for standardizing prevalence variables
normalize <- function(x) {
return ((x - min(x)) / (max(x) - min(x)))
}

places_tracts_sa_vars <- places_tracts_sa_sf %>%
# filter(StudyArea == "Outside CCDPH") %>%
  select(TractFIPS,
         StudyArea,
         SquareMiles,
         arth_cp = ARTHRITIS_CrudePrev,
         bph_cp = BPHIGH_CrudePrev,
         diab_cp = DIABETES_CrudePrev,
         obes_cp = OBESITY_CrudePrev,
         lpa_cp = LPA_CrudePrev) %>%
mutate(arth_std = normalize(arth_cp),
       bph_std = normalize(bph_cp),
       diab_std = normalize(diab_cp),
       obes_std = normalize(obes_cp),
       lpa_std = normalize(lpa_cp),
       cpi = (arth_std+bph_std+diab_std+obes_std+lpa_std)/5,
       cpi_ntile = ntile(cpi,5)) %>%
  left_join(acs2019_bytract,by=c("TractFIPS"="GEOID"))

# st_write(places_tracts_sa_vars, "../layers/places_tracts_sa_vars.shp", append=FALSE)

```


```{r lisa-clusters}

# Generate local moran statistics for all health categories
# Ii: local moran statistic; E.Ii: expectation of local moran statistic; Var.Ii: variance of local moran statistic; Z.Ii: standard deviate of local moran statistic; Pr(): p-value of local moran statistic

local_df_all <- read_rds("../data/local_df.rds")

for (i in 1:nrow(health_types)) {
  
  places_tracts_sa_sf_type <- places_tracts_sa_sf %>%
    st_drop_geometry() %>% 
    select(health_types$type[i],
           TractFIPS) %>%
    replace(is.na(.), 0)
  df_test <- places_tracts_sa_sf_type[[1]]
  
  local <- localmoran(x = df_test, listw = nb2listw(tracts_nb, style = "W"))
  
  local_df <- as.data.frame(local) %>%
    bind_cols(places_tracts_sa_sf_type) %>%
    rename(CrudePrev = 6) %>%
    mutate(type = health_types$type[i],
           CrudePrev_std = CrudePrev - mean(CrudePrev),
           Ii_std = Ii - mean(Ii),
           quadrant = case_when(CrudePrev_std>0 & Ii_std >0 ~ 1,
                                CrudePrev_std<0 & Ii_std <0 ~ 3,
                                CrudePrev_std<0 & Ii_std >0 ~ 2,
                                CrudePrev_std>0 & Ii_std <0 ~ 4),
           label = case_when(CrudePrev_std>0 & Ii_std >0 ~ "high-high",
                                CrudePrev_std<0 & Ii_std <0 ~ "low-low",
                                CrudePrev_std<0 & Ii_std >0 ~ "low-high",
                                CrudePrev_std>0 & Ii_std <0 ~ "high-low"),
           quadrant = if_else(`Pr(z > 0)`>0.01,0,quadrant),
           label = if_else(`Pr(z > 0)`>0.01,"not significant",label))
  
  local_df_all <- local_df_all %>%
    bind_rows(local_df)
}

# empty dataframe template
local_df <- local_df[0,]
write_rds(local_df, "../data/local_df.rds")

local_sf_all <- local_df_all %>%
  left_join(INIL_Tracts_geom, by=c("TractFIPS"="GEOID")) %>%
  filter(type=="LPA_CrudePrev",
         `Pr(z > 0)`<=0.01) %>% 
  st_as_sf() %>%
  st_transform(crs=4326)

pal_lisa <- colorFactor(
  palette = c('red', '#fadbd8', '#aed6f1', 'blue'),
  local_sf_all$label
)

leaflet() %>% 
  addPolygons(data=local_sf_all,
              fillColor = ~pal_lisa(label),
              weight = 0.1,
              opacity = 0.5,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7) %>%
    addPolygons(data=INIL_Counties_geom_sub,
              fill = FALSE,
              weight = 1,
              opacity = 0.5,
              color = "gray",
              dashArray = "3",
              fillOpacity = 0.7) %>%
  addLegend("bottomright", 
            pal = pal_lisa, 
            values=c("high-high","high-low","low-high","low-low"), 
            opacity = 1, 
            title="LISA clusters") %>%
  addProviderTiles(providers$CartoDB.Positron)


```

# Health disparity clusters
The Moran I statistic is 0.79, suggesting that diabetes prevalence is highly positively autocorrelated in the Chicago metropolitan area. That is, census tracts with high rates of diabetes are spatially clustered (p-value < 0.000). We can also consider the p-value as a measure of the statistical significance of the model.


```{r summary-tables}

places_tracts_sa_vars_in %>% st_drop_geometry() %>% group_by(cpi_ntile) %>% summarise(n())

places_tracts_sa_vars_sum <- places_tracts_sa_vars %>%
  st_drop_geometry() %>%
  mutate(cpi_group = case_when(cpi_ntile==1 ~ "Bottom Quintile",
                               cpi_ntile>=2 & cpi_ntile<=4 ~ "Middle Quintiles",
                               cpi_ntile==5 ~ "Top Quintile")) %>%
  group_by(cpi_group) %>%
  select(TotalPop,
         Pop18Pl,
         cpi,
         SquareMiles,
         PopWht,
         PopBlk,
         PopLat,
         PopBPov,
         TotalPov,
         arth_cp,
         bph_cp,
         diab_cp,
         obes_cp,
         lpa_cp) %>%
  summarise(NumTracts = n(),
            Population = sum(TotalPop),
            Area = sum(SquareMiles),
            PopDensity = sum(TotalPop/SquareMiles*TotalPop/sum(TotalPop)),
            WhiteNL = sum(PopWht)/sum(TotalPop)*100,
            BlackNL = sum(PopBlk)/sum(TotalPop)*100,
            Latinx = sum(PopLat)/sum(TotalPop)*100,
            PopBPov_p = sum(PopBPov)/sum(TotalPov)*100,
            CPI_wt = sum(cpi*Pop18Pl/sum(Pop18Pl))*100,
            Obes_wt = sum(obes_cp*Pop18Pl/sum(Pop18Pl)),
            Diab_wt = sum(diab_cp*Pop18Pl/sum(Pop18Pl)),
            LPA_wt = sum(lpa_cp*Pop18Pl/sum(Pop18Pl)),
            BPH_wt = sum(bph_cp*Pop18Pl/sum(Pop18Pl)),
            Arth_wt = sum(arth_cp*Pop18Pl/sum(Pop18Pl))) %>%
  t()



```
```{r appendix-places-variables-descriptions}
places_datadictionary %>%
  filter(str_detect(Name,"CrudePrev")) %>%
  mutate(Name = tolower(str_replace_all(Name, "_CrudePrev", ""))) %>%
  kbl(caption=paste0("Chronic Health Prevalance Variable Names and Descriptions")) %>%
  kable_classic(full_width=F)
```



